YUI.add("interedition-text",function(b){var a=b.namespace("interedition.text");a.RANGE_SORT=function(d,c){var f=d.range,e=c.range;return(f.start==e.start?e.end-f.end:f.start-e.start);};a.QName=function(d,c){this.namespace=d;this.localName=c;};a.QName.prototype.toString=function(){return(this.namespace==null?"":"{"+this.namespace+"}")+this.localName;};a.QName.fromString=function(e){var d=e.indexOf("{");if(d<0){return new a.QName(null,e);}var c=e.indexOf("}");if(c<d||c>=(e.length-1)){b.error("Invalid QName",e,{throwFail:true});}return new a.QName(e.substring(d+1,c),e.substring(c+1));};a.Range=function(d,c){this.start=d;this.end=c;};a.Range.prototype.length=function(){return this.end-this.start;};a.Range.prototype.of=function(c){return c.substring(this.start,this.end);};a.Range.prototype.precedes=function(c){return this.end<=c.start;};a.Range.prototype.equalsStartOf=function(c){return(this.start==c.start)&&(this.end==c.start);};a.Range.prototype.overlapsWith=function(c){return this.amountOfOverlapWith(c)>0;};a.Range.prototype.amountOfOverlapWith=function(c){return(Math.min(this.end,c.end)-Math.max(this.start,c.start));};a.Range.prototype.toId=function(){return"r"+this.start.toString()+"-"+this.end.toString();};a.Range.fromId=function(d){var c=d.replace("r","").split("-");return new a.Range(parseInt(c[0]),parseInt(c[1]));};a.Range.prototype.toString=function(){return"["+this.start+", "+this.end+"]";};a.Annotation=function(d,c,e){this.name=d;this.range=c;this.data=e;};a.Text=function(c){a.Text.superclass.constructor.apply(this,arguments);};a.Text.NAME="interedition-text";a.Text.ATTRS={text:{value:""},annotations:{value:[]},data:{getter:function(){return[this.get("text"),this.get("annotations")];},setter:function(c){this.set("text",c[0]);this.set("annotations",c[1]);}}};b.extend(a.Text,b.Base,{partition:function(){var d=[];b.each(this.get("annotations"),function(g){var h=g.range;if(d.indexOf(h.start)<0){d.push(h.start);}if(d.indexOf(h.end)<0){d.push(h.end);}});d.sort(function(h,g){return h-g;});var c=this.get("text").length;if(d.length==0||d[0]>0){d.unshift(0);}if(d.length==1||d[d.length-1]<c){d.push(c);}var e=[];var f=-1;b.each(d,function(g){if(f>=0){e.push(new a.Range(f,g));}f=g;});return e;},index:function(){var c=[];var d=this.get("annotations");b.each(this.partition(),function(f){var e=[];d=b.Array.filter(d,function(g){var h=g.range;if(h.overlapsWith(f)||h.equalsStartOf(f)){e.push(g);}return true;});c.push({range:f,annotations:e});});return c;},names:function(){var c=b.Array.map(this.get("annotations"),function(d){return d.name.toString();});c=b.Array.dedupe(c);c.sort();return b.Array.map(c,function(d){return a.QName.fromString(d);});}});a.Repository=function(c){a.Repository.superclass.constructor.apply(this,arguments);};a.Repository.NAME="text-repository";a.Repository.ATTRS={"base":{}};b.extend(a.Repository,b.Base,{"read":function(d,c){b.io(this.get("base")+"/text/"+d.toString(),{headers:{"Accept":"application/json"},on:{success:function(i,h){var e=b.JSON.parse(h.responseText);var g={};b.each(e.n||{},function(k,j){g[j]=new a.QName(k[0],k[1]);});var f=b.Array.map(e.a,function(j){var k=b.Array.map(j.d||[],function(l){return[g[l[0].toString()],l[1]];});return new a.Annotation(g[j.n.toString()],new a.Range(j.r[0],j.r[1]),k);});c.set("data",[(e.t||""),f]);}}});},"transform":function(e,d,c){b.io(this.get("base")+"/text/"+e.toString()+"/transform",{method:"post",headers:{"Content-Type":"application/json","Accept":"application/json"},data:b.JSON.stringify(d),on:{success:function(g,f){c(b.JSON.parse(f.responseText));}}});}});a.TextPanel=function(c){a.TextPanel.superclass.constructor.apply(this,arguments);};a.TextPanel.NAME="interedition-text-panel";a.TextPanel.ATTRS={node:{writeOnce:"initOnly",setter:function(c){var d=b.one(c);if(!d){throw ("TextPanel: Invalid node given: "+c);}return d;}},text:{writeOnce:"initOnly"},segments:{value:[]}};b.extend(a.TextPanel,b.Base,{initializer:function(c){this.get("text").after("dataChange",this.update,this);},update:function(){var e=this.get("node"),f=this.get("text"),c=this.get("segments");var d=f.get("text");e.empty();c.length=0;b.each(f.partition(),function(h){var k=h.start,g=h.end,i=h.toId();var j=b.Node.create("<span id='"+i+"'>"+b.Escape.html(d.substring(k,g)).replace("\n","<br>")+"</span>");e.append(j);c.push([h,j]);});this.fire("update");}});a.AnnotationNamesSelectionList=function(c){a.AnnotationNamesSelectionList.superclass.constructor.apply(this,arguments);};a.AnnotationNamesSelectionList.NAME="interedition-text-annotation-names-selection-list";a.AnnotationNamesSelectionList.ATTRS={node:{writeOnce:"initOnly",setter:function(c){var d=b.one(c);if(!d){throw ("AnnotationGutter: Invalid node given: "+c);}return d;}},textPanel:{},names:{value:[]},selectedNames:{value:[]}};b.extend(a.AnnotationNamesSelectionList,b.Base,{initializer:function(c){this.get("textPanel").on("update",this.update,this);},entryChanged:function(g){var f=this.get("names");var d=f[parseInt(g.target.getAttribute("id").replace("name-",""))].toString();var c=this.get("selectedNames");if(g.target.get("checked")){c.push(d);c.sort();}else{c=b.Array.filter(c,function(e){return(e!=d);});}this.set("selectedNames",c);},update:function(){var d=this.get("textPanel").get("text").names();this.set("names",d);var c=this.get("node");c.empty();b.each(d,function(h,f){var g="name-"+f;var e=b.Node.create(b.Lang.sub("<input type='checkbox' id='{id}' name='{id}' />",{id:g}));c.append(b.Node.create("<p/>").append(e).append("&nbsp;").append(b.Lang.sub("<label for='{id}'>{label}</label>",{id:g,label:h.toString()})));b.on("change",this.entryChanged,e,this);},this);}});a.AnnotationGutter=function(c){a.AnnotationGutter.superclass.constructor.apply(this,arguments);};a.AnnotationGutter.NAME="interedition-text-annotation-gutter";a.AnnotationGutter.ATTRS={node:{writeOnce:"initOnly",setter:function(c){var d=b.one(c);if(!d){throw ("AnnotationGutter: Invalid node given: "+c);}return d;}},textPanel:{}};b.extend(a.AnnotationGutter,b.Base,{initializer:function(c){this.get("textPanel").on("update",this.update,this);
},update:function(){var d=this.get("textPanel"),e=this.get("node");var c=d.get("node").get("region");e.empty();var f=d3.select(e.getDOMNode()).append("svg:svg").attr("width","100%").attr("height",c.height+"px");f.append("svg:rect").attr("x",10).attr("y",0).attr("width",30).attr("height",c.height).attr("stroke","#fff").attr("fill","#ffc").on("click",function(){alert("Click!");});}});},"@VERSION@",{requires:["base","array-extras","io","json","node","event"]});